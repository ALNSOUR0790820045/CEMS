# نظام النسخ الاحتياطي - CEMS ERP

## نظرة عامة

نظام النسخ الاحتياطي الشامل لحماية بيانات النظام والملفات. يتيح النظام إنشاء نسخ احتياطية تلقائية ويدوية، مع إمكانية الاسترجاع السريع.

## أنواع النسخ الاحتياطية

### 1. نسخ قاعدة البيانات (Database Backups)
- يتم نسخ جميع الجداول والبيانات في قاعدة البيانات
- الصيغة: SQL
- يتم الاحتفاظ بآخر 30 نسخة تلقائياً
- مدة النسخ: عادة 1-5 دقائق

### 2. نسخ الملفات (Files Backups)
- يتم نسخ المجلدات:
  - `storage/app/public` - الملفات المخزنة
  - `public/uploads` - الملفات المرفوعة
- الصيغة: ZIP
- يتم الاحتفاظ بآخر 10 نسخ تلقائياً
- مدة النسخ: تعتمد على حجم الملفات

### 3. النسخ الكامل (Full Backups)
- يجمع بين نسخ قاعدة البيانات والملفات
- ينشئ نسختين منفصلتين
- الأكثر أماناً للاسترجاع الكامل

## الأوامر المتاحة

### نسخ قاعدة البيانات
```bash
php artisan backup:database
php artisan backup:database --name="قبل_التحديث"
```

### نسخ الملفات
```bash
php artisan backup:files
php artisan backup:files --name="نسخة_الملفات_يناير"
```

### نسخ كامل
```bash
php artisan backup:full
php artisan backup:full --name="نسخة_شهرية"
```

## الجدولة التلقائية

يتم تشغيل النسخ الاحتياطية تلقائياً وفقاً للجدول التالي:

| النوع | التوقيت | الأمر |
|------|---------|-------|
| قاعدة البيانات | يومياً - 2:00 صباحاً | `backup:database` |
| الملفات | أسبوعياً - الأحد 3:00 صباحاً | `backup:files` |
| كامل | شهرياً - 4:00 صباحاً | `backup:full` |

لتفعيل الجدولة، تأكد من إضافة Cron Job:
```bash
* * * * * cd /path-to-project && php artisan schedule:run >> /dev/null 2>&1
```

## الواجهة البصرية

يمكن إدارة النسخ الاحتياطية من خلال الواجهة البصرية:

1. **صفحة القائمة** (`/backups`)
   - عرض جميع النسخ الاحتياطية
   - إحصائيات شاملة
   - تحميل النسخ
   - استرجاع قاعدة البيانات
   - حذف النسخ القديمة

2. **صفحة الإنشاء** (`/backups/create`)
   - اختيار نوع النسخة
   - تسمية النسخة (اختياري)
   - بدء عملية النسخ

## مسارات التخزين

```
storage/app/backups/
├── database/          # نسخ قاعدة البيانات (SQL)
└── files/            # نسخ الملفات (ZIP)
```

## استرجاع النسخ الاحتياطية

### من خلال الواجهة البصرية
1. انتقل إلى صفحة النسخ الاحتياطية
2. اضغط على زر "استرجاع" للنسخة المطلوبة
3. أكد العملية

### من خلال سطر الأوامر

#### استرجاع قاعدة البيانات (PostgreSQL)
```bash
PGPASSWORD="password" psql -h localhost -U username database_name < backup_file.sql
```

#### استرجاع قاعدة البيانات (MySQL)
```bash
mysql -h localhost -u username -p database_name < backup_file.sql
```

#### استرجاع الملفات
1. فك ضغط ملف ZIP
2. انسخ المجلدات إلى مواقعها الأصلية

## التنظيف التلقائي

- **نسخ قاعدة البيانات**: يتم الاحتفاظ بآخر 30 نسخة، وحذف الأقدم تلقائياً
- **نسخ الملفات**: يتم الاحتفاظ بآخر 10 نسخ، وحذف الأقدم تلقائياً

## الأمان

✅ جميع الملفات محمية من الوصول المباشر
✅ يتطلب تسجيل الدخول للوصول
✅ تأكيد قبل عمليات الاسترجاع والحذف
✅ لا يتم رفع ملفات SQL إلى Git
✅ تسجيل كامل لجميع العمليات

## استكشاف الأخطاء

### "Failed to create backup"
- تحقق من صلاحيات المجلدات
- تأكد من توفر مساحة كافية
- تحقق من إعدادات قاعدة البيانات

### "File not found"
- تأكد من وجود الملف في مسار التخزين
- تحقق من صلاحيات القراءة

### "Restore failed"
- تأكد من توافق نسخة قاعدة البيانات
- تحقق من إعدادات الاتصال

## الصيانة

### النسخ اليدوي
يُنصح بإنشاء نسخ يدوية قبل:
- التحديثات الكبرى
- تغييرات هيكلية
- عمليات الصيانة
- ترحيل البيانات

### المراقبة
راقب:
- حجم النسخ الاحتياطية
- مساحة التخزين المتاحة
- سجلات الأخطاء
- نجاح العمليات المجدولة

## الدعم الفني

في حالة وجود مشاكل، تواصل مع فريق الدعم الفني مع توفير:
- نوع النسخة الاحتياطية
- رسالة الخطأ
- سجلات النظام (logs)
- وقت حدوث المشكلة

---

**آخر تحديث**: 2026-01-05
**الإصدار**: 1.0.0
